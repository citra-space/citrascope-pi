name: Build CitraScope Image

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    env:
      IMAGE_VERSION: "dev"  # Default, overridden by Determine version step
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Tagged release: extract version from tag (e.g., refs/tags/v0.1.0 -> v0.1.0)
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          # Dev build: use main-YYYYMMDD-SHORTSHA format
          VERSION="main-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
        fi
        echo "IMAGE_VERSION=${VERSION}" >> $GITHUB_ENV
        echo "Version: ${VERSION}"
    
    - name: Build Docker image
      run: |
        USER_ID=$(id -u)
        GROUP_ID=$(id -g)
        docker build \
          --build-arg USER_ID=${USER_ID} \
          --build-arg GROUP_ID=${GROUP_ID} \
          -t lemon-pi-builder .
    
    - name: Build Pi image
      run: |
        docker run --rm --privileged \
          -v "$(pwd):/workspace" \
          -v /dev:/dev \
          -e IMAGE_VERSION="${IMAGE_VERSION}" \
          lemon-pi-builder \
          bash -c "sudo python3 build_image.py -o citrascope-pi-\${IMAGE_VERSION}.img && sudo chown builder:builder /workspace/citrascope-pi-\${IMAGE_VERSION}.img"
    
    - name: Compress image
      run: |
        echo "Compressing image with xz..."
        xz -9 -v citrascope-pi-${IMAGE_VERSION}.img
        echo "Compressed size:"
        ls -lh citrascope-pi-${IMAGE_VERSION}.img.xz
    
    - name: Upload image artifact
      uses: actions/upload-artifact@v4
      with:
        name: citrascope-pi-${{ env.IMAGE_VERSION }}
        path: 'citrascope-pi-${{ env.IMAGE_VERSION }}.img.xz'
        retention-days: 7
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: citrascope-pi-${{ env.IMAGE_VERSION }}.img.xz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
